/* v - 1.1.62
 * Â© Miles Nature 
 * Build time: 08-30-2020 09:49:14
 */
const html=document.getElementsByTagName("HTML")[0],body=document.body,bmkSection=document.getElementById("bookmarks"),footer=document.getElementsByTagName("footer")[0],templateFormEdit=document.getElementById("templateFormEdit"),templateFormSettings=document.getElementById("templateFormSettings"),templateModalHelp=document.getElementById("templateModalHelp"),templateLoader=document.getElementById("templateLoader"),urlCheck=/((http|ftp|https|file):\/\/)/,domainUrl=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/",api={getBookmarks:()=>{const e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){const t=e.status;(0===t||t>=200&&t<400)&&this.responseText?(bookmarksArray=JSON.parse(this.responseText)).length>0?bookmarks.constructSection():(actionFromFooter("create"),toggleModalHelp("add"),bookmarks.remove()):edit.displayErrorMessage(this.responseText)}},e.open("GET",domainUrl+"bookmarks",!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send()},verbBookmark:(e,t,o,a)=>{const r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===XMLHttpRequest.DONE){const e=r.status;(0===e||e>=200&&e<400)&&this.responseText?(edit.resetFields(),a()):edit.displayErrorMessage(this.responseText)}},r.open(e,t,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(o)}},bookmarks={sortGroup:(e,t)=>{const o=e.group;o&&(groupsByName.hasOwnProperty(o)?groupsByName[o].push(e):(groupsByName[o]=[e],groups.push(o)))},sortIntoGroups:e=>(groupsByName=[],groups=[],e.forEach(bookmarks.sortGroup),groupsByName),constructList:e=>{let t,o=document.createDocumentFragment(),a=item,r=document.createElement("UL"),d=document.createAttribute("class"),n=document.createAttribute("id"),i=document.createAttribute("title"),s=document.createElement("LI"),l=document.createElement("BUTTON"),c=document.createAttribute("class"),m=document.createTextNode(a),u=document.createAttribute("title"),p=document.createElement("UL");for(d.value="bookmarks",r.setAttributeNode(d),n.value="_"+a,r.setAttributeNode(n),i.value=a+" Group",r.setAttributeNode(i),c.value="all",l.setAttributeNode(c),u.value="Open all bookmarks in"+a+"group.",l.setAttributeNode(u),l.appendChild(m),t=0;t<e.length;t+=1){let o=e[t];if(!o.group||!o.name||!o.url)continue;let a=document.createElement("LI"),r=document.createElement("A"),d=document.createAttribute("id"),n=document.createAttribute("href"),i=document.createAttribute("target"),s=document.createAttribute("rel"),l=document.createTextNode(o.name);d.value=o._id,r.setAttributeNode(d),n.value=o.url,r.setAttributeNode(n),i.value="_blank",r.setAttributeNode(i),s.value="noreferrer",r.setAttributeNode(s),r.appendChild(l),a.appendChild(r),p.appendChild(a)}return s.appendChild(l),s.appendChild(p),r.appendChild(s),o.appendChild(r),o},constructSection:()=>{let e=bookmarksArray,t=document.createDocumentFragment();for(item in sortedList=bookmarks.sortIntoGroups(e),bookmarks.remove(),sortedList)item&&(group=sortedList[item],t.appendChild(bookmarks.constructList(group)));bmkSection.appendChild(t),openGroup.setupEventHandler(),edit.container&&(bookmarks.constructGroupOptions(),bookmarks.constructNameOptions(sortedList),edit.resetFields(),removeChildNodes(edit.errorMessage)),dropEvents("add"),dragEnterEvents("add")},remove:()=>{bmkSection.hasChildNodes()&&removeChildNodes(bmkSection)},constructGroupOptions:()=>{let e=document.createDocumentFragment();groups.forEach((t,o)=>{option=document.createElement("OPTION"),val=document.createAttribute("value"),text=document.createTextNode(t),val.value=t,option.setAttributeNode(val),option.appendChild(text),e.appendChild(option)}),edit.container&&(edit.groupSelect.hasChildNodes()&&removeChildNodes(edit.groupSelect),edit.groupSelect.appendChild(e))},constructNameOptions:(e,t)=>{let o=(()=>document.createDocumentFragment())(),a=[];for(item in e){if(!item)continue;a=e[item];let t=document.createDocumentFragment(),r=document.createElement("OPTGROUP"),d=document.createAttribute("label"),n=(e,o)=>{option=document.createElement("OPTION"),val=document.createAttribute("value"),text=document.createTextNode(e.name),val.value=e._id,option.setAttributeNode(val),option.appendChild(text),t.appendChild(option)};d.value=item,r.setAttributeNode(d),a.forEach(n),r.appendChild(t),o.appendChild(r)}if(edit.container){edit.nameSelect.hasChildNodes()&&removeChildNodes(edit.nameSelect),edit.bookmarksSelect.hasChildNodes()&&removeChildNodes(edit.bookmarksSelect);let e=o.cloneNode(!0);edit.nameSelect.appendChild(o),edit.bookmarksSelect.appendChild(e),edit.updatePrefill()}},storage:{set:e=>{localStorage.setItem("bookmarks",e)},get:()=>{const e=localStorage.getItem("bookmarks");return e?JSON.parse(e):""}},toggleLoader:e=>{const t=bmkSection.querySelector("svg#loader");switch(e){case"remove":t&&bookmarks.remove();break;case"add":t||bmkSection.appendChild(templateLoader.content.cloneNode(!0))}}},openGroup={getLists:()=>Array.prototype.slice.call(document.getElementsByClassName("bookmarks")),openNewTab:(e,t,o)=>{window.open(e,"_blank"),window.focus()},getUrls:e=>{let t=[];return e.forEach((e,o,a)=>{t.push(e.firstChild.href)}),t},openTabs:e=>{let t=e.target,o=[],a=[],r=[];o=Array.prototype.slice.call(t.parentNode.children),a=Array.prototype.slice.call(o[1].getElementsByTagName("LI")),(r=openGroup.getUrls(a)).forEach(openGroup.openNewTab)},setupEventHandler:(e,t,o)=>{bmkSection.addEventListener("click",e=>{e.target.classList.contains("all")&&openGroup.openTabs(e)})}},settings={toggleSettings:e=>{const t=document.getElementById("settings");switch(e){case"remove":t&&(settings.container.removeEventListener("change",e=>{}),settings.container.removeEventListener("click",e=>{}),t.remove(),localStorage.setItem("settings","closed"));break;case"add":if(!t){body.prepend(templateFormSettings.content.cloneNode(!0)),localStorage.setItem("settings","open");const e=localStorage.getItem("appearance");e&&(document.querySelector("input[value="+e+"]").checked="checked"),settings.container=document.forms[0],settings.container.addEventListener("change",e=>{const t=e.target,o=t.tagName,a=t.value;switch(o){case"INPUT":switch(body.classList.remove("light-mode","dark-mode"),a){case"default":localStorage.setItem("appearance","default");break;case"light":localStorage.setItem("appearance","light"),body.classList.add("light-mode");break;case"dark":localStorage.setItem("appearance","dark"),body.classList.add("dark-mode")}}}),settings.container.addEventListener("click",e=>{switch(e.target.tagName){case"BUTTON":case"svg":case"path":case"polyline":settings.toggleSettings("remove")}})}}}},edit={toggleEdit:e=>{const t=document.getElementById("edit");switch(e){case"remove":t&&(edit.container.removeEventListener("change",e=>{}),edit.container.removeEventListener("click",e=>{}),t.remove(),localStorage.setItem("edit","closed"));break;case"add":t||(body.prepend(templateFormEdit.content.cloneNode(!0)),edit.container=document.forms[0],edit.errorMessage=document.getElementById("errorMessage"),edit.bookmark=document.getElementById("bookmark"),edit.group=document.getElementById("group"),edit.bookmarksSelect=document.getElementById("bookmarksSelect"),edit.groupText=document.getElementById("groupText"),edit.groupSelect=document.getElementById("groupSelect"),edit.nameText=document.getElementById("nameText"),edit.nameSelect=document.getElementById("nameSelect"),edit.urlText=document.getElementById("urlText"),edit.buttonSubmit=document.getElementById("submit"),edit.updateBookmarkSelectValue=(()=>bookmarksSelect.value),edit.updateBookmarkSelectText=(()=>bookmarksSelect.options.length>0?bookmarksSelect.options[bookmarksSelect.selectedIndex].text:""),edit.groupValue=(()=>groupText.value),edit.groupSelectValue=(()=>groupSelect.value),edit.groupSelectText=(()=>groupSelect.options.length>0?groupSelect.options[groupSelect.selectedIndex].text:""),edit.titleValue=(()=>nameText.value),edit.titleSelectValue=(()=>nameSelect.value),edit.titleSelectText=(()=>nameSelect.options.length>0?nameSelect.options[nameSelect.selectedIndex].text:""),edit.urlValue=(()=>urlText.value),edit.actionValue=(()=>document.querySelector('input[name="action"]:checked').value),edit.elementValue=(()=>document.querySelector('input[name="element"]:checked').value),edit.removeClasses=((...e)=>{edit.container&&edit.container.classList.remove(...e)}),edit.addClasses=((...e)=>{edit.container&&edit.container.classList.add(...e)}),edit.updateButton=(e=>{edit.container&&(edit.buttonSubmit.value=e)}),edit.container&&(bookmarks.constructGroupOptions(),bookmarks.constructNameOptions(sortedList),localStorage.setItem("edit","open"),edit.container.addEventListener("change",e=>{const t=e.target,o=t.tagName,a=t.name;switch(o){case"INPUT":switch(a){case"action":edit.actionState(),edit.elementState();break;case"element":edit.elementState()}break;case"SELECT":"name_select"===a&&edit.updatePrefill()}}),edit.container.addEventListener("click",e=>{const t=e.target,o=t.tagName,a=t.name;switch(o){case"INPUT":"submit"===a&&edit.editSubmit(e);break;case"BUTTON":case"svg":case"path":case"polyline":edit.toggleEdit("remove")}})))}},updatePrefill:()=>{if(bookmarksArray.length>0){let e="",t=edit.updateBookmarkSelectText(),o="",a=edit.updateBookmarkSelectValue(),r=(t,r)=>{t._id===a&&(e=t.group,o=t.url)};bookmarksArray.forEach(r),edit.groupText&&(edit.groupText.value=e),edit.nameText&&(edit.nameText.value=t),edit.urlText&&(edit.urlText.value=o)}},actionState:()=>{const e=edit.actionValue();edit.removeClasses("create","delete","update"),edit.resetFields(),removeChildNodes(edit.errorMessage),edit.addClasses(e),edit.updateButton(e),"update"===e&&(edit.bookmark.checked="checked",edit.updatePrefill())},elementState:()=>{const e=edit.elementValue(),t=edit.actionValue();edit.removeClasses("bookmark","group"),removeChildNodes(edit.errorMessage),edit.addClasses(e),"update"!==t&&edit.resetFields()},getStates:()=>{const e=edit.actionValue(),t=edit.elementValue();return{isCreate:"create"===e,isDelete:"delete"===e,isUpdate:"update"===e,isGroup:"group"===t,isBookmark:"bookmark"===t,action:e,element:t}},getValues:()=>{const e=edit.getStates(),t={group:(()=>e.isGroup&&e.isCreate||e.isBookmark&&e.isUpdate?edit.groupValue():e.isGroup&&e.isDelete||e.isBookmark&&e.isCreate?edit.groupSelectText():"")(),id:(()=>e.isBookmark&&e.isDelete?edit.titleSelectValue():e.isBookmark&&e.isUpdate?edit.updateBookmarkSelectValue():"")(),name:(()=>e.isBookmark&&e.isDelete?edit.titleSelectText():(e.isBookmark||e.isGroup)&&e.isCreate||e.isBookmark&&e.isUpdate?edit.titleValue():"")(),url:(()=>(e.isBookmark||e.isGroup)&&e.isCreate||e.isBookmark&&e.isUpdate?edit.urlValue():"")()};return{action:e.action,element:e.element,state:e,config:t}},resetFields:()=>{edit.groupText&&(edit.groupText.value=""),edit.nameText&&(edit.nameText.value=""),edit.urlText&&(edit.urlText.value="")},displayErrorMessage:(...e)=>{if(edit.errorMessage.value&&removeChildNodes(edit.errorMessage),e){if(Array.isArray(e)&&e.length>0){let t=document.createDocumentFragment(),o=(e,o)=>{if(""===e)return;let a=document.createTextNode(e+String.fromCharCode(13));t.appendChild(a)};e.forEach(o),edit.errorMessage.appendChild(t)}else{let t=document.createDocumentFragment(),o=document.createTextNode(e);t.appendChild(o),edit.errorMessage.appendChild(t)}edit.errorMessage.focus()}},editSubmit:e=>{e.preventDefault(),removeChildNodes(edit.errorMessage);const t=edit.getValues(),o=t.state,a={action:(()=>t.action?t.action&&t.action.length>25?"Action exceeds maximum character length of 25.":"":"Action is required.")(),element:(()=>t.element?t.element&&t.element.length>25?"Element exceeds maximum character length of 25.":"":"Element is required.")(),name:(()=>t.config.name?t.config.name.length>100?"Name exceeds maximum character length of 100.":"":"Name is required.")(),url:(()=>t.config.url?t.config.url.length>2083?"URL exceeds maximum character length of 2083.":!1===urlCheck.test(t.config.url)?"URL is invalid.":"":"URL is required.")(),group:(()=>t.config.group?t.config.group.length>100?"Group exceeds maximum character length of 100.":"":"Group is required.")(),id:(()=>t.config.id?t.config.id.length>25?"ID exceeds maximum character length of 25.":"":"ID is required.")()};let r="";""===a.action&&""===a.element?(o.isCreate&&(o.isBookmark||o.isGroup)&&(""===a.name&&""===a.url&&""===a.group?(r="name="+t.config.name+"&url="+t.config.url+"&group="+t.config.group,api.verbBookmark("POST",domainUrl+"bookmarks",r,api.getBookmarks)):edit.displayErrorMessage(a.group,a.name,a.url)),o.isDelete&&o.isBookmark&&(""===a.id?api.verbBookmark("DELETE",domainUrl+"bookmarks/"+t.config.id,r,api.getBookmarks):edit.displayErrorMessage(a.id)),o.isDelete&&o.isGroup&&(""===a.group?api.verbBookmark("DELETE",domainUrl+"bookmarks/group/"+t.config.group,r,api.getBookmarks):edit.displayErrorMessage(a.group)),o.isUpdate&&o.isBookmark&&(""===a.name&&""===a.url&&""===a.group&&""===a.id?(r="name="+t.config.name+"&url="+t.config.url+"&group="+t.config.group,api.verbBookmark("PUT",domainUrl+"bookmarks/"+t.config.id,r,api.getBookmarks)):edit.displayErrorMessage(a.group,a.name,a.url,a.id))):edit.displayErrorMessage(a.action,a.element)}},actionFromFooter=e=>{const t=document.getElementById("edit"),o=document.getElementById("settings");switch(e){case"settings":o||(t&&t.remove(),settings.toggleSettings("add")),document.querySelector('input[name="appearance"]:checked').focus();break;default:t||(o&&o.remove(),edit.toggleEdit("add"));const a=document.querySelector("input[value="+e+"]");a.checked="checked",a.focus(),edit.actionState(),edit.elementState()}},allowDrop=e=>{e.preventDefault()},dragStart=e=>{const t=e.target,o=t.tagName?t.tagName:"",a=t.href?t.href:"",r=t.text?t.text:"",d=t.id?t.id:"";"A"===o&&(e.dataTransfer.setData("tag",o),e.dataTransfer.setData("href",a),e.dataTransfer.setData("text",r),e.dataTransfer.setData("id",d))},dragEnter=e=>{let t=e.target.closest("ul.bookmarks");e.preventDefault(),cleanupDragHover(),t.classList.add("drag-hover")},cleanupDragHover=()=>{let e=openGroup.getLists();removeBackgroundColor=((e,t)=>{e.classList.remove("drag-hover")}),e.forEach(removeBackgroundColor)},drop=e=>{e.preventDefault();let t=e.target,o=e.dataTransfer.getData("tag")?e.dataTransfer.getData("tag"):"",a=e.dataTransfer.getData("href")?e.dataTransfer.getData("href"):"",r=e.dataTransfer.getData("text")?e.dataTransfer.getData("text"):"",d=e.dataTransfer.getData("id")?e.dataTransfer.getData("id"):"",n=t.closest("ul.bookmarks").id.substr(1),i="A"===o&&a&&d,s=e=>urlCheck.test(a);""===o&&""===a&&(a=r,s()&&(actionFromFooter("create"),body.scrollTop=0,document.documentElement.scrollTop=0,edit.urlText.value=a,edit.groupSelect.value=n)),i&&s()&&(actionFromFooter("update"),body.scrollTop=0,document.documentElement.scrollTop=0,bookmarksSelect.value=d,edit.updatePrefill(),edit.groupText.value=n),cleanupDragHover()},dropEvents=e=>{switch(lists=openGroup.getLists(),addDrop=((e,t)=>{e.addEventListener("drop",e=>{drop(e)})}),removeDrop=((e,t)=>{e.removeEventListener("drop",e=>{drop(e)})}),e){case"add":lists.forEach(addDrop);break;case"remove":lists.forEach(removeDrop)}},dragEnterEvents=e=>{switch(lists=openGroup.getLists(),addDragEnter=((e,t)=>{e.addEventListener("dragenter",e=>{dragEnter(e)})}),removeDragEnter=((e,t)=>{e.removeEventListener("dragenter",e=>{dragEnter(e)})}),e){case"add":lists.forEach(addDragEnter);break;case"remove":lists.forEach(removeDragEnter)}},removeChildNodes=e=>{const t=e&&e.hasChildNodes(),o=e.tagName,a=e=>{let t=e.lastElementChild;for(;t;)e.removeChild(t),t=e.lastElementChild};if(t)switch(o){case"TEXTAREA":e.textContent="";break;case"SECTION":dropEvents("remove"),dragEnterEvents("remove"),a(e);break;default:a(e)}},toggleModalHelp=e=>{const t=document.querySelector("div.modal.help");switch(e){case"remove":t&&t.remove();break;case"add":t||document.body.appendChild(templateModalHelp.content.cloneNode(!0))}};let bookmarksArray=[],groupsByName=[],groups=[],sortedList=[];window.onload=(()=>{bookmarks.toggleLoader("add"),api.getBookmarks();const e=localStorage.getItem("edit"),t=localStorage.getItem("settings"),o=localStorage.getItem("appearance");"open"===e?edit.toggleEdit("add"):"open"===t&&settings.toggleSettings("add"),o&&"default"!==o&&body.classList.add(o+"-mode"),footer.addEventListener("click",e=>{const t=e.target,o=t.tagName,a=t.id,r=t.className;switch(o){case"BUTTON":actionFromFooter(r),body.scrollTop=0,document.documentElement.scrollTop=0;break;case"A":"help"===a&&toggleModalHelp("add")}});const a=new Date;document.getElementById("year").innerText=a.getFullYear(),html.addEventListener("dragover",e=>{allowDrop(e)}),html.addEventListener("dragstart",e=>{dragStart(e)})});
