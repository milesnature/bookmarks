/* v - 1.1.18
 * Â© Miles Nature 
 * Build time: 08-24-2020 11:13:29
 */
const html=document.getElementsByTagName("HTML")[0],body=document.body,bmkSection=document.getElementById("bookmarks"),footer=document.getElementsByTagName("footer")[0],templateForm=document.getElementById("templateForm"),templateModalHelp=document.getElementById("templateModalHelp"),templateLoader=document.getElementById("templateLoader"),urlCheck=/((http|ftp|https|file):\/\/)/,domainUrl=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/",api={getBookmarks:()=>{const e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){const t=e.status;(0===t||t>=200&&t<400)&&this.responseText?(bookmarksArray=JSON.parse(this.responseText)).length>0?bookmarks.constructSection():(form.actionFromFooter("create",!0),toggleModalHelp("add"),bookmarks.remove()):form.displayErrorMessage(this.responseText)}},e.open("GET",domainUrl+"bookmarks",!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send()},verbBookmark:(e,t,o,r)=>{const a=new XMLHttpRequest;a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE){const e=a.status;(0===e||e>=200&&e<400)&&this.responseText?(form.resetFields(),r()):form.displayErrorMessage(this.responseText)}},a.open(e,t,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(o)}},bookmarks={sortGroup:(e,t)=>{const o=e.group;o&&(groupsByName.hasOwnProperty(o)?groupsByName[o].push(e):(groupsByName[o]=[e],groups.push(o)))},sortIntoGroups:e=>(groupsByName=[],groups=[],e.forEach(bookmarks.sortGroup),groupsByName),constructList:e=>{let t,o=document.createDocumentFragment(),r=item,a=document.createElement("UL"),n=document.createAttribute("class"),m=document.createAttribute("id"),l=document.createElement("LI"),s=document.createElement("BUTTON"),d=document.createAttribute("class"),c=document.createTextNode(r),i=document.createElement("UL");for(n.value="bookmarks",a.setAttributeNode(n),m.value="_"+r,a.setAttributeNode(m),d.value="all",s.setAttributeNode(d),s.appendChild(c),t=0;t<e.length;t+=1){let o=e[t];if(!o.group||!o.name||!o.url)continue;let r=document.createElement("LI"),a=document.createElement("A"),n=document.createAttribute("id"),m=document.createAttribute("href"),l=document.createAttribute("target"),s=document.createAttribute("rel"),d=document.createTextNode(o.name);n.value=o._id,a.setAttributeNode(n),m.value=o.url,a.setAttributeNode(m),l.value="_blank",a.setAttributeNode(l),s.value="noreferrer",a.setAttributeNode(s),a.appendChild(d),r.appendChild(a),i.appendChild(r)}return l.appendChild(s),l.appendChild(i),a.appendChild(l),o.appendChild(a),o},constructSection:()=>{let e=bookmarksArray,t=document.createDocumentFragment();for(item in sortedList=bookmarks.sortIntoGroups(e),bookmarks.remove(),sortedList)item&&(group=sortedList[item],t.appendChild(bookmarks.constructList(group)));bmkSection.appendChild(t),openGroup.setupEventHandler(),form.container&&(bookmarks.constructGroupOptions(),bookmarks.constructNameOptions(sortedList),form.resetFields(),removeChildNodes(form.errorMessage)),addDropEvents(),addDragEnterEvents()},remove:()=>{bmkSection.hasChildNodes()&&removeChildNodes(bmkSection)},constructGroupOptions:()=>{let e=document.createDocumentFragment();groups.forEach((t,o)=>{option=document.createElement("OPTION"),val=document.createAttribute("value"),text=document.createTextNode(t),val.value=t,option.setAttributeNode(val),option.appendChild(text),e.appendChild(option)}),form.container&&(form.groupSelect.hasChildNodes()&&removeChildNodes(form.groupSelect),form.groupSelect.appendChild(e))},constructNameOptions:(e,t)=>{let o=(()=>document.createDocumentFragment())(),r=[];for(item in e){if(!item)continue;r=e[item];let t=document.createDocumentFragment(),a=document.createElement("OPTGROUP"),n=document.createAttribute("label"),m=(e,o)=>{option=document.createElement("OPTION"),val=document.createAttribute("value"),text=document.createTextNode(e.name),val.value=e._id,option.setAttributeNode(val),option.appendChild(text),t.appendChild(option)};n.value=item,a.setAttributeNode(n),r.forEach(m),a.appendChild(t),o.appendChild(a)}if(form.container){form.nameSelect.hasChildNodes()&&removeChildNodes(form.nameSelect),form.bookmarksSelect.hasChildNodes()&&removeChildNodes(form.bookmarksSelect);let e=o.cloneNode(!0);form.nameSelect.appendChild(o),form.bookmarksSelect.appendChild(e),form.updatePrefill()}},storage:{set:e=>{localStorage.setItem("bookmarks",e)},get:()=>{const e=localStorage.getItem("bookmarks");return e?JSON.parse(e):""}},toggleLoader:e=>{const t=bmkSection.querySelector("svg#loader");switch(e){case"remove":t&&bookmarks.remove();break;case"add":t||bmkSection.appendChild(templateLoader.content.cloneNode(!0))}}},openGroup={getLists:()=>Array.prototype.slice.call(document.getElementsByClassName("bookmarks")),openNewTab:(e,t,o)=>{window.open(e,"_blank"),window.focus()},getUrls:e=>{let t=[];return e.forEach((e,o,r)=>{t.push(e.firstChild.href)}),t},openTabs:e=>{let t=e.target,o=[],r=[],a=[];o=Array.prototype.slice.call(t.parentNode.children),r=Array.prototype.slice.call(o[1].getElementsByTagName("LI")),(a=openGroup.getUrls(r)).forEach(openGroup.openNewTab)},setupEventHandler:(e,t,o)=>{bmkSection.addEventListener("click",e=>{e.target.classList.contains("all")&&openGroup.openTabs(e)})}},form={toggleForm:e=>{const t=document.forms[0];switch(e){case"remove":t&&(form.container.removeEventListener("change",e=>{}),form.container.removeEventListener("click",e=>{}),t.remove(),localStorage.setItem("form","closed"));break;case"add":t||(body.prepend(templateForm.content.cloneNode(!0)),form.container=document.forms[0],form.errorMessage=document.getElementById("errorMessage"),form.bookmark=document.getElementById("bookmark"),form.group=document.getElementById("group"),form.bookmarksSelect=document.getElementById("bookmarksSelect"),form.groupText=document.getElementById("groupText"),form.groupSelect=document.getElementById("groupSelect"),form.nameText=document.getElementById("nameText"),form.nameSelect=document.getElementById("nameSelect"),form.urlText=document.getElementById("urlText"),form.buttonSubmit=document.getElementById("submit"),form.updateBookmarkSelectValue=(()=>bookmarksSelect.value),form.updateBookmarkSelectText=(()=>bookmarksSelect.options.length>0?bookmarksSelect.options[bookmarksSelect.selectedIndex].text:""),form.groupValue=(()=>groupText.value),form.groupSelectValue=(()=>groupSelect.value),form.groupSelectText=(()=>groupSelect.options.length>0?groupSelect.options[groupSelect.selectedIndex].text:""),form.titleValue=(()=>nameText.value),form.titleSelectValue=(()=>nameSelect.value),form.titleSelectText=(()=>nameSelect.options.length>0?nameSelect.options[nameSelect.selectedIndex].text:""),form.urlValue=(()=>urlText.value),form.actionValue=(()=>document.querySelector('input[name="action"]:checked').value),form.elementValue=(()=>document.querySelector('input[name="element"]:checked').value),form.removeClasses=((...e)=>{form.container&&form.container.classList.remove(...e)}),form.addClasses=((...e)=>{form.container&&form.container.classList.add(...e)}),form.updateButton=(e=>{form.container&&(form.buttonSubmit.value=e)}),form.container&&(bookmarks.constructGroupOptions(),bookmarks.constructNameOptions(sortedList),localStorage.setItem("form","open"),form.container.addEventListener("change",e=>{const t=e.target,o=t.tagName,r=t.name;switch(o){case"INPUT":switch(r){case"action":form.actionState(),form.elementState();break;case"element":form.elementState()}break;case"SELECT":"name_select"===r&&form.updatePrefill()}}),form.container.addEventListener("click",e=>{const t=e.target,o=t.tagName,r=t.name;switch(o){case"INPUT":"submit"===r&&form.formSubmit(e);break;case"BUTTON":case"svg":case"path":case"polyline":form.toggleForm("remove")}})))}},actionFromFooter:e=>{form.toggleForm("add"),document.querySelector("input[value="+e+"]").checked="checked",form.actionState(),form.elementState()},updatePrefill:()=>{if(bookmarksArray.length>0){let e="",t=form.updateBookmarkSelectText(),o="",r=form.updateBookmarkSelectValue(),a=(t,a)=>{t._id===r&&(e=t.group,o=t.url)};bookmarksArray.forEach(a),form.groupText&&(form.groupText.value=e),form.nameText&&(form.nameText.value=t),form.urlText&&(form.urlText.value=o)}},actionState:()=>{const e=form.actionValue();form.removeClasses("create","delete","update"),form.resetFields(),removeChildNodes(form.errorMessage),form.addClasses(e),form.updateButton(e),"update"===e&&(form.bookmark.checked="checked",form.updatePrefill())},elementState:()=>{const e=form.elementValue(),t=form.actionValue();form.removeClasses("bookmark","group"),removeChildNodes(form.errorMessage),form.addClasses(e),"update"!==t&&form.resetFields()},getStates:()=>{const e=form.actionValue(),t=form.elementValue();return{isCreate:"create"===e,isDelete:"delete"===e,isUpdate:"update"===e,isGroup:"group"===t,isBookmark:"bookmark"===t,action:e,element:t}},getValues:()=>{const e=form.getStates(),t={group:(()=>e.isGroup&&e.isCreate||e.isBookmark&&e.isUpdate?form.groupValue():e.isGroup&&e.isDelete||e.isBookmark&&e.isCreate?form.groupSelectText():"")(),id:(()=>e.isBookmark&&e.isDelete?form.titleSelectValue():e.isBookmark&&e.isUpdate?form.updateBookmarkSelectValue():"")(),name:(()=>e.isBookmark&&e.isDelete?form.titleSelectText():(e.isBookmark||e.isGroup)&&e.isCreate||e.isBookmark&&e.isUpdate?form.titleValue():"")(),url:(()=>(e.isBookmark||e.isGroup)&&e.isCreate||e.isBookmark&&e.isUpdate?form.urlValue():"")()};return{action:e.action,element:e.element,state:e,config:t}},resetFields:()=>{form.groupText&&(form.groupText.value=""),form.nameText&&(form.nameText.value=""),form.urlText&&(form.urlText.value="")},displayErrorMessage:(...e)=>{if(removeChildNodes(form.errorMessage),e)if(Array.isArray(e)&&e.length>0){let t=document.createDocumentFragment(),o=(e,o)=>{if(""===e)return;let r=document.createElement("LI"),a=document.createTextNode(e);r.appendChild(a),t.appendChild(r)};e.forEach(o),form.errorMessage.appendChild(t)}else{let t=document.createDocumentFragment(),o=document.createTextNode(e);t.appendChild(o),form.errorMessage.appendChild(t)}},formSubmit:e=>{e.preventDefault(),removeChildNodes(form.errorMessage);const t=form.getValues(),o=t.state,r={action:(()=>t.action?t.action&&t.action.length>25?"Action exceeds maximum character length of 25.":"":"Action is required.")(),element:(()=>t.element?t.element&&t.element.length>25?"Element exceeds maximum character length of 25.":"":"Element is required.")(),name:(()=>t.config.name?t.config.name.length>100?"Name exceeds maximum character length of 100.":"":"Name is required.")(),url:(()=>t.config.url?t.config.url.length>2083?"URL exceeds maximum character length of 2083.":!1===urlCheck.test(t.config.url)?"URL is invalid.":"":"URL is required.")(),group:(()=>t.config.group?t.config.group.length>100?"Group exceeds maximum character length of 100.":"":"Group is required.")(),id:(()=>t.config.id?t.config.id.length>25?"ID exceeds maximum character length of 25.":"":"ID is required.")()};let a="";""===r.action&&""===r.element?(o.isCreate&&(o.isBookmark||o.isGroup)&&(""===r.name&&""===r.url&&""===r.group?(a="name="+t.config.name+"&url="+t.config.url+"&group="+t.config.group,api.verbBookmark("POST",domainUrl+"bookmarks",a,api.getBookmarks)):form.displayErrorMessage(r.group,r.name,r.url)),o.isDelete&&o.isBookmark&&(""===r.id?api.verbBookmark("DELETE",domainUrl+"bookmarks/"+t.config.id,a,api.getBookmarks):form.displayErrorMessage(r.id)),o.isDelete&&o.isGroup&&(""===r.group?api.verbBookmark("DELETE",domainUrl+"bookmarks/group/"+t.config.group,a,api.getBookmarks):form.displayErrorMessage(r.group)),o.isUpdate&&o.isBookmark&&(""===r.name&&""===r.url&&""===r.group&&""===r.id?(a="name="+t.config.name+"&url="+t.config.url+"&group="+t.config.group,api.verbBookmark("PUT",domainUrl+"bookmarks/"+t.config.id,a,api.getBookmarks)):form.displayErrorMessage(r.group,r.name,r.url,r.id))):form.displayErrorMessage(r.action,r.element)}},allowDrop=e=>{e.preventDefault()},dragStart=e=>{const t=e.target,o=t.tagName?t.tagName:"",r=t.href?t.href:"",a=t.text?t.text:"",n=t.id?t.id:"";"A"===o&&(e.dataTransfer.setData("tag",o),e.dataTransfer.setData("href",r),e.dataTransfer.setData("text",a),e.dataTransfer.setData("id",n))},dragEnter=e=>{let t=e.target.closest("ul.bookmarks");e.preventDefault(),cleanupDragHover(),t.classList.add("drag-hover")},cleanupDragHover=()=>{let e=openGroup.getLists();removeBackgroundColor=((e,t)=>{e.classList.remove("drag-hover")}),e.forEach(removeBackgroundColor)},drop=e=>{e.preventDefault();let t=e.target,o=e.dataTransfer.getData("tag")?e.dataTransfer.getData("tag"):"",r=e.dataTransfer.getData("href")?e.dataTransfer.getData("href"):"",a=e.dataTransfer.getData("text")?e.dataTransfer.getData("text"):"",n=e.dataTransfer.getData("id")?e.dataTransfer.getData("id"):"",m=t.closest("ul.bookmarks").id.substr(1),l="A"===o&&r&&n,s=e=>urlCheck.test(r);""===o&&""===r&&(r=a,s()&&(form.actionFromFooter("create"),body.scrollTop=0,document.documentElement.scrollTop=0,form.urlText.value=r,form.groupSelect.value=m)),l&&s()&&(form.actionFromFooter("update"),body.scrollTop=0,document.documentElement.scrollTop=0,bookmarksSelect.value=n,form.updatePrefill(),form.groupText.value=m),cleanupDragHover()},addDropEvents=()=>{lists=openGroup.getLists(),addDrop=((e,t)=>{e.addEventListener("drop",e=>{drop(e)})}),lists.forEach(addDrop)},addDragEnterEvents=()=>{lists=openGroup.getLists(),addDragEnter=((e,t)=>{e.addEventListener("dragenter",e=>{dragEnter(e)})}),lists.forEach(addDragEnter)},removeChildNodes=e=>{if(e&&e.hasChildNodes()){let t=e.lastElementChild;for(;t;)e.removeChild(t),t=e.lastElementChild}e&&e.textContent.length&&(e.textContent="")},toggleModalHelp=e=>{const t=document.querySelector("div.modal.help");switch(e){case"remove":t&&t.remove();break;case"add":t||document.body.appendChild(templateModalHelp.content.cloneNode(!0))}};let bookmarksArray=[],groupsByName=[],groups=[],sortedList=[];window.onload=(()=>{bookmarks.toggleLoader("add"),api.getBookmarks(),"open"===localStorage.getItem("form")&&form.toggleForm("add"),footer.addEventListener("click",e=>{const t=e.target,o=t.tagName,r=t.id,a=t.className;switch(o){case"BUTTON":form.actionFromFooter(a),body.scrollTop=0,document.documentElement.scrollTop=0;break;case"A":"help"===r&&toggleModalHelp("add")}});const e=new Date;document.getElementById("year").innerText=e.getFullYear(),html.addEventListener("dragover",e=>{allowDrop(e)}),html.addEventListener("dragstart",e=>{dragStart(e)})});
